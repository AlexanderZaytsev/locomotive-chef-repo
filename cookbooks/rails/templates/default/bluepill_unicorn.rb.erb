Bluepill.application("<%= @name %>") do |app|
  app.working_dir = "/u/apps/<%= @name %>/current"
  app.process("<%= @name %>") do |process|
    process.start_command = "cd /u/apps/<%= @name %>/current && bundle exec unicorn /u/apps/<%= @name %>/current/config.ru -c /u/apps/<%= @name %>/config/unicorn.rb -D -E production"
    process.stop_command = "kill -QUIT {{PID}}"
    process.restart_command = "kill -USR2 {{PID}}"
    process.stdout = process.stderr = "/u/apps/<%= @name %>/shared/log/unicorn.log"
    process.pid_file = "/u/apps/<%= @name %>/shared/pids/unicorn.pid"

    process.checks :mem_usage, :every => 10.seconds, :below => 100.megabytes, :times => [3, 5]

    process.uid = "deploy"
    process.gid = "deploy"

    process.start_grace_time = 10.seconds
    process.restart_grace_time = 10.seconds

    process.checks :flapping, :times => 2, :within => 30.seconds, :retry_in => 7.seconds

    process.monitor_children do |cp|
      cp.checks :mem_usage, :every => 10.seconds, :below => 100.megabytes, :times => [3, 5]
      cp.stop_command = "kill -QUIT {{PID}}"
    end
  end
end